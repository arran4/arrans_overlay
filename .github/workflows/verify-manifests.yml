name: Verify Manifests

on:
  push:
    paths:
      - '**/Manifest'
  pull_request:
    paths:
      - '**/Manifest'

jobs:
  verify-manifests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install g2
        run: |
          sudo apt-get update
          sudo apt-get install -y wget jq coreutils
          url="$(curl -s --header "Accept: application/vnd.github+json" --header "Authorization: Bearer ${{secrets.GITHUB_TOKEN}}" https://api.github.com/repos/arran4/g2/releases/latest | jq -r '.assets[].browser_download_url | select(endswith("_linux_amd64.deb"))')"
          wget "${url}" -O /tmp/g2.deb
          sudo dpkg -i /tmp/g2.deb
          rm /tmp/g2.deb

      - name: Identify changed Manifests
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE="origin/${{ github.base_ref }}"
            HEAD="HEAD"
          else
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
            # Handle empty before (new branch)
            if [ -z "$BASE" ] || [ "$BASE" == "0000000000000000000000000000000000000000" ]; then
               BASE="HEAD~1"
            fi
          fi

          echo "Comparing $BASE to $HEAD"
          CHANGED_FILES=$(git diff --name-only $BASE $HEAD -- '**/Manifest' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No Manifest files changed."
            echo "dirs=" >> $GITHUB_OUTPUT
          else
            # Extract directories
            DIRS=$(echo "$CHANGED_FILES" | xargs -n1 dirname | sort -u | tr '\n' ' ')
            echo "Changed directories: $DIRS"
            echo "dirs=$DIRS" >> $GITHUB_OUTPUT
          fi

      - name: Verify Manifests
        if: steps.changed-files.outputs.dirs != ''
        run: |
          python3 scripts/verify_manifest.py ${{ steps.changed-files.outputs.dirs }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: update Manifest files"
          title: "fix: update Manifest files"
          body: |
            Manifest files were verified and updated using `g2`.

            This PR is auto-generated by the [Verify Manifests] workflow.
          branch: fix/manifest-updates
          delete-branch: true
          base: ${{ github.head_ref || github.ref_name }}
