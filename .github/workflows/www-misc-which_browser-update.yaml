name: www-misc/which_browser update

permissions:
  contents: write

on:
  schedule:
    - cron: '15 12 * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/www-misc-which_browser-update.yaml'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: false

env:
  ebuild_category: www-misc
  ebuild_name: which_browser
  description: "Which Browser? A browser selecting tool with rules to automate."
  homepage: "https://which-browser-site.pages.dev"
  license: "All-rights-reserved"
  keywords: "~amd64"
  base_url: https://which-browser-site.pages.dev/releases
  workflow_filename: www-misc-which_browser-update.yaml

jobs:
  check-and-create-ebuild:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget jq coreutils
          url="$(curl -s --header "Accept: application/vnd.github+json" --header "Authorization: Bearer ${{secrets.GITHUB_TOKEN}}" https://api.github.com/repos/arran4/g2/releases/latest | jq -r '.assets[].browser_download_url | select(endswith("_linux_amd64.deb"))')"
          echo "$url"
          wget "${url}" -O /tmp/g2.deb
          sudo dpkg -i /tmp/g2.deb
          rm /tmp/g2.deb

      - name: Process releases
        id: process_releases
        run: |
          ebuild_dir="./${{ env.ebuild_category }}/${{ env.ebuild_name }}"
          mkdir -p "$ebuild_dir"
          # Scrape the XML for .deb filenames to capture full version including build suffix
          # This looks for patterns like which_browser-0.2.6+44-linux.deb
          # And handles HTML entity &#43; for +
          filenames=$(curl -s "${{ env.base_url }}/index.xml" | grep -o 'which_browser-[0-9.]\+\(&#43;\|+\)[0-9]\+-linux.deb' | sed 's/&#43;/+/g' | sort -Vr | uniq)

          for filename in $filenames; do
            # Extract version from filename: which_browser-0.2.6+44-linux.deb -> 0.2.6+44
            full_version_str=$(echo "$filename" | sed -E 's/^which_browser-(.+)-linux\.deb$/\1/')

            # Split into base version and build suffix
            base_version="${full_version_str%+*}"
            build_suffix="${full_version_str#*+}"

            if [ -z "$base_version" ] || [ -z "$build_suffix" ]; then
              echo "Skipping unexpected version format in filename: $filename"
              continue
            fi

            # Construct Gentoo PV: 0.2.6+44 -> 0.2.6.44
            version="${base_version}.${build_suffix}"

            archive_name="$filename"
            ebuild_file="${ebuild_dir}/${{ env.ebuild_name }}-${version}.ebuild"

            if [ ! -f "$ebuild_file" ]; then
              cat <<EOT > "$ebuild_file"
            # Generated via: https://github.com/arran4/arrans_overlay/blob/main/.github/workflows/${{ env.workflow_filename }}
            EAPI=8

            # Upstream changed their download host from arran4.sdf.org to
            # https://which-browser-site.pages.dev, update SRC_URI accordingly.

            DESCRIPTION="${{ env.description }}"
            HOMEPAGE="${{ env.homepage }}"

            MY_BASE_PV=\${PV%.*}
            MY_BUILD_SUFFIX=\${PV##*.}

            if [[ \${MY_BASE_PV} == \${PV} ]] || [[ -z \${MY_BUILD_SUFFIX} ]]; then
                    die "Unexpected PV format: \${PV}"
            fi

            MY_DEB_ARCHIVE="\${PN}-\${MY_BASE_PV}+\${MY_BUILD_SUFFIX}-linux.deb"

            # Updated SRC_URI for new host structure: downloads/vBase/file
            SRC_URI="https://which-browser-site.pages.dev/downloads/v\${MY_BASE_PV}/\${MY_DEB_ARCHIVE}"
            LICENSE="${{ env.license }}"
            SLOT="0"
            KEYWORDS="${{ env.keywords }}"
            IUSE=""

            RDEPEND="|| ( dev-libs/libayatana-appindicator )"
            RESTRICT="mirror"

            S="\${WORKDIR}"

            inherit unpacker

            src_unpack() {
                    unpack_deb "\${MY_DEB_ARCHIVE}"
            }

            src_install() {
                    # Install the contents of the deb package
                    # find .
                    cp -vr "\${S}"/usr/ "\${D}"/usr/

                    # Ensure the executable has the correct permissions
                    fperms 0755 /usr/share/which_browser/which_browser

                    # Create a symlink in /usr/bin for easy access
                    dosym /usr/share/which_browser/which_browser /usr/bin/which_browser

                    # Ensure the desktop file has the correct permissions
                    if [[ -f "\${D}/usr/share/applications/which_browser.desktop" ]]; then
                            fperms 0644 /usr/share/applications/which_browser.desktop
                    fi

                    # Ensure the icon file has the correct permissions
                    if [[ -f "\${D}/usr/share/icons/hicolor/256x256/apps/which_browser.png" ]]; then
                            fperms 0644 /usr/share/icons/hicolor/256x256/apps/which_browser.png
                    fi
            }

            pkg_postinst() {
                    einfo "Which Browser? has been installed."
                    einfo "Please set Which Browser? as the default HTTP and HTTPS handler."
            }
          EOT
              sed -i 's/^            //' "$ebuild_file"
              # SRC_URI logic: https://which-browser-site.pages.dev/downloads/v${MY_BASE_PV}/${MY_DEB_ARCHIVE}
              # g2 manifest upsert-from-url "https://which-browser-site.pages.dev/downloads/v${base_version}/${archive_name}" "${archive_name}" "${ebuild_dir}/Manifest"
              # Need to be explicit with URL here for g2

              BASE_URL="https://which-browser-site.pages.dev/downloads" g2 manifest upsert-from-url "https://which-browser-site.pages.dev/downloads/v${base_version}/${archive_name}" "${archive_name}" "${ebuild_dir}"
              echo "generated_version=${version}" >> $GITHUB_OUTPUT
            fi
            break
          done

      - name: Commit and push changes
        run: |
          ebuild_dir="./${{ env.ebuild_category }}/${{ env.ebuild_name }}"
          generated_version="${{ steps.process_releases.outputs.generated_version }}"
          if [ -n "$generated_version" ]; then
            git add "$ebuild_dir"
            git commit -m "Add ebuild for which_browser ${generated_version}" &&
            git pull --rebase &&
            git push || true
          fi
        if: steps.process_releases.outputs.generated_version
